<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="flex items-center justify-between mb-8 animate-fade-in-up">
        <div>
            <h1 class="text-4xl font-bold mb-2">Administrar Men√∫</h1>
            <p class="text-lg opacity-70">A√±ade o edita los productos de tu cafeter√≠a</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Formulario -->
        <div class="lg:col-span-1 card bg-base-100 shadow-xl border border-base-300 h-fit">
            <div class="card-body p-6">
                <h3 class="card-title text-xl font-bold border-b border-base-300 pb-3 mb-4">
                    {{ isEditing ? 'Editar Producto' : 'Nuevo Producto' }}
                </h3>
                
                <form (ngSubmit)="initiateSave()" class="flex flex-col gap-4" novalidate>
                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text font-bold">Nombre</span>
                        </div>
                        <input type="text" id="name" [(ngModel)]="currentItem.name" name="name" required
                               class="input input-bordered w-full focus:input-primary"
                               placeholder="Ej. Latte Vainilla">
                    </label>
                    
                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text font-bold">Categor√≠a</span>
                        </div>
                        <select id="category" [(ngModel)]="currentItem.category" name="category" required
                                class="select select-bordered w-full focus:select-primary">
                            @for (cat of categories; track cat) {
                                <option [value]="cat">{{ cat }}</option>
                            }
                        </select>
                    </label>

                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text font-bold">Precio ($)</span>
                        </div>
                        <input type="number" id="price" [(ngModel)]="currentItem.price" name="price" required min="1"
                               class="input input-bordered w-full focus:input-primary"
                               placeholder="0.00">
                    </label>

                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text font-bold">Descripci√≥n (Opcional)</span>
                        </div>
                        <textarea id="description" [(ngModel)]="currentItem.description" name="description" rows="3"
                                  class="textarea textarea-bordered w-full focus:textarea-primary resize-none"
                                  placeholder="Ej. Shot de espresso..."></textarea>
                    </label>
                    
                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text font-bold">Imagen del Producto (Opcional)</span>
                        </div>
                        <div class="relative w-full">
                            <input type="file" accept="image/*" (change)="onFileSelected($event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                            <div class="flex items-center gap-2">
                                <button type="button" class="btn btn-neutral pointer-events-none">Elegir Archivo</button>
                                <span class="opacity-70 text-sm italic pointer-events-none">Ning√∫n archivo seleccionado</span>
                            </div>
                            <div class="text-[11px] opacity-60 mt-2 font-medium">üí° Recomendado: 800x800px (Foto cuadrada del producto)</div>
                        </div>
                        @if (imagePreviewUrl) {
                            <div class="mt-2">
                                <span class="text-xs opacity-70 mb-1 block">Vista Previa:</span>
                                <div class="avatar">
                                    <div class="w-32 rounded-md border border-base-300 shadow-sm">
                                        <img [src]="imagePreviewUrl" loading="lazy" alt="Preview">
                                    </div>
                                </div>
                            </div>
                        }
                    </label>
                    
                    <div class="flex gap-3 mt-4">
                        @if (isEditing) {
                            <button type="button" (click)="cancelEdit()" class="btn btn-outline flex-1">
                                Cancelar
                            </button>
                        }
                        <button type="submit" [disabled]="isSaving || !currentItem.name || currentItem.price <= 0"
                                class="btn btn-primary flex-1 shadow-md">
                            @if (isSaving) {
                                <span class="loading loading-spinner"></span>
                                Guardando...
                            } @else {
                                {{ isEditing ? 'Actualizar' : 'Crear Producto' }}
                            }
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla -->
        <div class="lg:col-span-2 card bg-base-100 shadow-xl border border-base-300 overflow-hidden">
            <div class="px-6 py-4 border-b border-base-300 bg-base-200">
                <h3 class="text-xl font-bold">Men√∫ Actual</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm md:table-md w-full">
                    <thead class="bg-base-300 text-base-content text-sm uppercase">
                        <tr>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Precio</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (item of menuItems$ | async; track item.id) {
                            <tr class="hover">
                                <td class="font-medium">
                                    <div class="flex items-center gap-3">
                                        <div class="avatar">
                                            <div class="mask mask-squircle w-12 h-12 flex items-center justify-center bg-base-200 border border-base-300">
                                                @if (item.imageUrl) {
                                                    <img [src]="item.imageUrl" loading="lazy" alt="{{item.name}}" class="cursor-pointer hover:opacity-80 transition-opacity" title="Ver tama√±o completo" (click)="openImagePreview(item.imageUrl)">
                                                } @else {
                                                    <svg class="w-6 h-6 opacity-50 m-auto mt-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                                }
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-bold">{{ item.name }}</div>
                                            @if (item.description) {
                                                <div class="text-sm opacity-50 truncate" style="max-width: 200px;" title="{{item.description}}">{{ item.description }}</div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="badge badge-ghost">{{ item.category }}</div>
                                </td>
                                <td class="text-primary font-bold">
                                    ${{ item.price | number:'1.2-2' }}
                                </td>
                                <td class="text-right">
                                    <button (click)="editItem(item)" class="btn btn-sm btn-ghost text-info hover:bg-info/10">Editar</button>
                                    <button (click)="initiateDelete(item.id)" class="btn btn-sm btn-ghost text-error hover:bg-error/10">Eliminar</button>
                                </td>
                            </tr>
                        } @empty {
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center opacity-50 italic">
                                    Todav√≠a no hay productos en el men√∫. Utiliza el formulario para crear el primero.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Toast Notification -->
@if (toastMessage) {
    <div class="toast toast-end toast-bottom z-50 animate-fade-in-up">
        <div class="alert alert-success bg-success text-success-content shadow-lg max-w-sm rounded-box border-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span class="font-bold whitespace-normal">{{ toastMessage }}</span>
        </div>
    </div>
}

<!-- Image Preview Modal / Lightbox -->
<dialog class="modal" [class.modal-open]="showImagePreview">
    <div class="modal-box bg-transparent shadow-none p-0 overflow-visible max-w-4xl relative flex justify-center items-center h-full">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 lg:-right-12 lg:top-0 text-white bg-black/60 hover:bg-black/90 z-50 text-xl" 
                (click)="closeImagePreview()">‚úï</button>
        @if (previewImageUrl) {
            <img [src]="previewImageUrl" class="object-contain max-h-[85vh] w-auto max-w-full rounded-2xl shadow-2xl scale-100 animate-zoom-in" alt="Vista Previa">
        }
    </div>
    <!-- Clickeo afuera cierra el modal -->
    <form method="dialog" class="modal-backdrop bg-black/80 backdrop-blur-sm" (click)="closeImagePreview()">
        <button>cerrar</button>
    </form>
</dialog>

<!-- Confirmation Modal -->
@if (showConfirmModal) {
    <div class="modal modal-open animate-fade-in backdrop-blur-sm">
        <div class="modal-box bg-base-100 border border-base-300 animate-scale-in">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <span class="text-warning text-2xl">‚ö†Ô∏è</span> Confirmar Acci√≥n
            </h3>
            <p class="py-4 opacity-80">
                {{ confirmAction === 'delete' ? '¬øEst√°s seguro de que deseas eliminar este producto del men√∫? Esta acci√≥n no se puede deshacer.' : '¬øEst√°s seguro de que deseas guardar los cambios en este producto?' }}
            </p>
            <div class="modal-action">
                <button (click)="cancelConfirm()" class="btn btn-outline">Cancelar</button>
                <button (click)="confirmActionExecution()" class="btn" [class.btn-error]="confirmAction === 'delete'" [class.btn-primary]="confirmAction !== 'delete'">
                    S√≠, Continuar
                </button>
            </div>
        </div>
    </div>
}


